<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bros Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0d0d0d; --panel:#1a1a1a; --neon:#00ff66; --muted:#82ffa6; }
    * { box-sizing:border-box; }
    body { margin:0; background:var(--bg); color:var(--neon); font-family:system-ui, Segoe UI, Trebuchet MS, sans-serif; }
    header { padding:1.5rem; text-align:center; background:var(--panel); border-bottom:2px solid var(--neon); }
    nav { position:sticky; top:0; z-index:10; background:var(--bg); border-bottom:2px solid var(--neon); }
    nav ul { list-style:none; display:flex; flex-wrap:wrap; gap:.5rem; padding:.6rem; margin:0; justify-content:center; }
    nav a { color:var(--neon); text-decoration:none; padding:.4rem .8rem; border:1px solid var(--neon); border-radius:4px; font-weight:600; }
    nav a:hover { background:var(--neon); color:var(--bg); }
    section { max-width:1100px; margin:auto; padding:1rem 1rem 2rem; }
    h2 { margin:.5rem 0 1rem; padding-bottom:.4rem; border-bottom:2px solid var(--neon); }
    .panel { background:var(--panel); border:1px solid var(--neon); border-radius:8px; padding:1rem; }
    .list { display:flex; flex-direction:column; gap:.6rem; }
    .item { display:flex; align-items:flex-start; justify-content:space-between; gap:.8rem; border:1px dashed var(--neon); border-radius:6px; padding:.6rem; }
    .item-main { flex:1; white-space:pre-wrap; }
    .item-meta { font-size:.85rem; color:var(--muted); margin-top:.25rem; }
    .actions { display:flex; gap:.4rem; }
    .btn { background:none; border:1px solid var(--neon); color:var(--neon); padding:.25rem .6rem; border-radius:4px; cursor:pointer; }
    .btn:hover { background:var(--neon); color:var(--bg); }
    form { display:grid; gap:.6rem; margin-top:.8rem; }
    input, textarea, button { background:var(--bg); color:var(--neon); border:1px solid var(--neon); border-radius:6px; padding:.6rem; }
    textarea { min-height:90px; }
    .grid-2 { grid-template-columns:1fr 1fr; }
    .grid-3 { grid-template-columns:repeat(3,1fr); }
    .calendar-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:.5rem; }
    .day { background:var(--panel); border:1px solid var(--neon); border-radius:6px; min-height:100px; padding:.5rem; }
    .day strong { display:block; margin-bottom:.3rem; }
    #toast { position:fixed; bottom:20px; right:20px; background:var(--neon); color:var(--bg); padding:.7rem 1rem; border-radius:6px; box-shadow:0 0 20px rgba(0,255,102,.35); display:none; font-weight:700; }
  </style>
</head>
<body>
  <header>
    <h1>Bros Hub</h1>
    <div class="item-meta">Neon-green, modular, cross-device notifications enabled</div>
  </header>

  <nav>
    <ul>
      <li><a href="#chat">Chat</a></li>
      <li><a href="#stories">Stories</a></li>
      <li><a href="#notes">Notes</a></li>
      <li><a href="#calendar">Calendar</a></li>
      <li><a href="#news">News</a></li>
      <li><a href="#announcements">Announcements</a></li>
      <li><a href="#admins">Admins</a></li>
      <li><a href="#attractions">Attractions</a></li>
    </ul>
  </nav>

  <!-- Chat -->
  <section id="chat">
    <h2>Chat</h2>
    <div class="panel">
      <div id="messages" class="list"></div>
      <form id="messageForm">
        <input id="messageInput" placeholder="Type message..." required />
        <button type="submit" class="btn">Send</button>
      </form>
    </div>
  </section>

  <!-- Stories -->
  <section id="stories">
    <h2>Stories</h2>
    <div class="panel">
      <div id="storiesBoard" class="list"></div>
      <form id="storyForm">
        <input id="storyTitle" placeholder="Title" required />
        <textarea id="storyContent" placeholder="Content" required></textarea>
        <button type="submit" class="btn">Add Story</button>
      </form>
    </div>
  </section>

  <!-- Notes -->
  <section id="notes">
    <h2>Notes</h2>
    <div class="panel">
      <div id="notesBoard" class="list"></div>
      <form id="noteForm">
        <input id="noteInput" placeholder="Write a note..." required />
        <button type="submit" class="btn">Add Note</button>
      </form>
    </div>
  </section>

  <!-- Calendar (simple demo grid; events saved to firestore, listed inline) -->
  <section id="calendar">
    <h2>Calendar</h2>
    <div class="panel">
      <div id="calendarGrid" class="calendar-grid"></div>
      <form id="eventForm" class="grid-3">
        <input id="eventDay" type="number" min="1" max="31" placeholder="Day (1-31)" required />
        <input id="eventName" placeholder="Event name" required />
        <button type="submit" class="btn">Add Event</button>
      </form>
    </div>
  </section>

  <!-- News -->
  <section id="news">
    <h2>News</h2>
    <div class="panel">
      <div id="newsBoard" class="list"></div>
      <form id="newsForm">
        <input id="newsTitle" placeholder="Headline" required />
        <textarea id="newsContent" placeholder="News content..." required></textarea>
        <button type="submit" class="btn">Add News</button>
      </form>
    </div>
  </section>

  <!-- Announcements -->
  <section id="announcements">
    <h2>Announcements</h2>
    <div class="panel">
      <div id="announcementsBoard" class="list"></div>
      <form id="announcementForm">
        <input id="announcementTitle" placeholder="Title" required />
        <textarea id="announcementContent" placeholder="Details..." required></textarea>
        <button type="submit" class="btn">Add Announcement</button>
      </form>
    </div>
  </section>

  <!-- Admins (cards) -->
  <section id="admins">
    <h2>Admins</h2>
    <div class="panel">
      <div id="adminsBoard" class="list"></div>
      <form id="adminForm" class="grid-2">
        <input id="adminName" placeholder="Admin name" required />
        <input id="adminRole" placeholder="Role" required />
        <button type="submit" class="btn">Add Admin</button>
      </form>
    </div>
  </section>

  <!-- Attractions (name + price) -->
  <section id="attractions">
    <h2>Attractions</h2>
    <div class="panel">
      <div id="attractionsBoard" class="list"></div>
      <form id="attractionForm" class="grid-2">
        <input id="attractionName" placeholder="Attraction name" required />
        <input id="attractionPrice" type="number" step="0.01" placeholder="Price" required />
        <button type="submit" class="btn">Add Attraction</button>
      </form>
    </div>
  </section>

  <!-- Toast -->
  <div id="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, onSnapshot, query, orderBy,
      serverTimestamp, doc, deleteDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-messaging.js";

    // Your provided config
    const firebaseConfig = {
      apiKey: "AIzaSyAOWDg95YOPCBYzN5vWOVBik0AUNOyqZeI",
      authDomain: "bros-hub-cdbf2.firebaseapp.com",
      projectId: "bros-hub-cdbf2",
      storageBucket: "bros-hub-cdbf2.firebasestorage.app",
      messagingSenderId: "704367128264",
      appId: "1:704367128264:web:2234b7b809a4691b327ffd",
      measurementId: "G-1DG5BKM4SH"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const messaging = getMessaging(app);

    // Toast helper
    function showToast(msg) {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.style.display = "block";
      setTimeout(() => { t.style.display = "none"; }, 1800);
    }

    // Service worker for background notifications
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/firebase-messaging-sw.js")
        .then(() => console.log("SW registered"))
        .catch(console.error);
    }

    // Request permission + save token
    async function initNotifications() {
      const permission = await Notification.requestPermission();
      if (permission !== "granted") return;
      const token = await getToken(messaging, {
        vapidKey: "BN8Symzqm70UMkbPp5CnnLg6_BcvXiKjeeLgCI10CYgC6vbNz0eN_XnA6TukL7Ozp_AtohIon7ZdtaO_gORRwHc"
      });
      if (token) {
        await addDoc(collection(db, "fcmTokens"), {
          token, tsClient: Date.now(), tsServer: serverTimestamp()
        });
        console.log("FCM token saved:", token);
      }
    }
    initNotifications();

    // Foreground push handling
    onMessage(messaging, payload => {
      const title = payload?.notification?.title || "New update";
      const body = payload?.notification?.body || "";
      new Notification(title, { body });
    });

    // Generic board renderer with edit/delete
    function renderBoard(boardId, snapDocs, formatFn, collName) {
      const board = document.getElementById(boardId);
      board.innerHTML = "";
      snapDocs.forEach(docSnap => {
        const data = docSnap.data();
        const item = document.createElement("div");
        item.className = "item";

        const main = document.createElement("div");
        main.className = "item-main";
        main.innerHTML = formatFn(data);

        const actions = document.createElement("div");
        actions.className = "actions";

        const editBtn = document.createElement("button");
        editBtn.className = "btn";
        editBtn.textContent = "Edit";
        editBtn.onclick = async () => {
          const json = prompt("Edit as JSON (e.g., {\"text\":\"Hello\"})", JSON.stringify(data, null, 2));
          if (!json) return;
          try {
            const parsed = JSON.parse(json);
            await updateDoc(doc(db, collName, docSnap.id), parsed);
            showToast("Updated");
          } catch (e) { alert("Invalid JSON"); }
        };

        const delBtn = document.createElement("button");
        delBtn.className = "btn";
        delBtn.textContent = "Delete";
        delBtn.onclick = async () => {
          await deleteDoc(doc(db, collName, docSnap.id));
          showToast("Deleted");
        };

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);

        item.appendChild(main);
        item.appendChild(actions);
        board.appendChild(item);
      });
    }

    // Collections
    const messagesRef = collection(db, "messages");
    const storiesRef = collection(db, "stories");
    const notesRef = collection(db, "notes");
    const newsRef = collection(db, "news");
    const announcementsRef = collection(db, "announcements");
    const adminsRef = collection(db, "admins");
    const attractionsRef = collection(db, "attractions");
    const eventsRef = collection(db, "events");

    // Live queries
    onSnapshot(query(messagesRef, orderBy("tsClient","asc")), snap => {
      renderBoard("messages", snap.docs, d => `<div>${d.text ?? ""}</div><div class="item-meta">${new Date(d.tsClient||Date.now()).toLocaleString()}</div>`, "messages");
    });
    onSnapshot(query(storiesRef, orderBy("tsClient","desc")), snap => {
      renderBoard("storiesBoard", snap.docs, d => `<strong>${d.title ?? "Untitled"}</strong>\n${d.content ?? ""}`, "stories");
    });
    onSnapshot(query(notesRef, orderBy("tsClient","desc")), snap => {
      renderBoard("notesBoard", snap.docs, d => `${d.text ?? ""}`, "notes");
    });
    onSnapshot(query(newsRef, orderBy("tsClient","desc")), snap => {
      renderBoard("newsBoard", snap.docs, d => `<strong>${d.title ?? "Headline"}</strong>\n${d.content ?? ""}`, "news");
    });
    onSnapshot(query(announcementsRef, orderBy("tsClient","desc")), snap => {
      renderBoard("announcementsBoard", snap.docs, d => `<strong>${d.title ?? "Announcement"}</strong>\n${d.content ?? ""}`, "announcements");
    });
    onSnapshot(query(adminsRef, orderBy("tsClient","desc")), snap => {
      renderBoard("adminsBoard", snap.docs, d => `<strong>${d.name ?? "Admin"}</strong>\nRole: ${d.role ?? "-"}`, "admins");
    });
    onSnapshot(query(attractionsRef, orderBy("tsClient","desc")), snap => {
      renderBoard("attractionsBoard", snap.docs, d => `<strong>${d.name ?? "Attraction"}</strong>\nPrice: ${d.price ?? "-"}`, "attractions");
    });

    // Simple calendar grid (1..31)
    const calGrid = document.getElementById("calendarGrid");
    for (let i=1;i<=31;i++){
      const cell = document.createElement("div");
      cell.className = "day";
      cell.id = `day-${i}`;
      cell.innerHTML = `<strong>${i}</strong><div class="item-meta">No events</div>`;
      calGrid.appendChild(cell);
    }
    onSnapshot(query(eventsRef, orderBy("tsClient","desc")), snap => {
      // Reset labels
      for (let i=1;i<=31;i++){
        const cell = document.getElementById(`day-${i}`);
        const meta = cell.querySelector(".item-meta");
        if (meta) meta.textContent = "No events";
        cell.querySelectorAll(".event").forEach(n => n.remove());
      }
      snap.docs.forEach(d => {
        const e = d.data();
        const cell = document.getElementById(`day-${e.day}`);
        if (!cell) return;
        const span = document.createElement("div");
        span.className = "event";
        span.textContent = e.name;
        cell.appendChild(span);
        const meta = cell.querySelector(".item-meta");
        if (meta) meta.textContent = "";
      });
    });

    // Form handlers (each add shows a toast; Cloud Functions send cross-device push)
    document.getElementById("messageForm").addEventListener("submit", async e => {
      e.preventDefault();
      const text = document.getElementById("messageInput").value.trim();
      if (!text) return;
      await addDoc(messagesRef, { text, tsClient: Date.now(), tsServer: serverTimestamp() });
      e.target.reset();
      showToast("Message sent");
    });

    document.getElementById("storyForm").addEventListener("submit", async e => {
      e.preventDefault();
      const title = document.getElementById("storyTitle").value.trim();
      const content = document.getElementById("storyContent").value.trim();
      await addDoc(storiesRef, { title, content, tsClient: Date.now(), tsServer: serverTimestamp() });
      e.target.reset();
      showToast("Story added");
    });

    document.getElementById("noteForm").addEventListener("submit", async e => {
      e.preventDefault();
      const text = document.getElementById("noteInput").value.trim();
      await addDoc(notesRef, { text, tsClient: Date.now(), tsServer: serverTimestamp() });
      e.target.reset();
      showToast("Note added");
    });

    document.getElementById("newsForm").addEventListener("submit", async e => {
      e.preventDefault();
      const title = document.getElementById("newsTitle").value.trim();
      const content = document.getElementById("newsContent").value.trim();
      await addDoc(newsRef, { title, content, tsClient: Date.now(), tsServer: serverTimestamp() });
      e.target.reset();
      showToast("News posted");
    });

    document.getElementById("announcementForm").addEventListener("submit", async e => {
      e.preventDefault();
      const title = document.getElementById("announcementTitle").value.trim();
      const content = document.getElementById("announcementContent").value.trim();
      await addDoc(announcementsRef, { title, content, tsClient: Date.now(), tsServer: serverTimestamp() });
      e.target.reset();
      showToast("Announcement posted");
    });

    document.getElementById("adminForm").addEventListener("submit", async e => {
      e.preventDefault();
      const name = document.getElementById("adminName").value.trim();
      const role = document.getElementById("adminRole").value.trim();
      await addDoc(adminsRef, { name, role, tsClient: Date.now(), tsServer: serverTimestamp() });
      e.target.reset();
      showToast("Admin added");
    });

    document.getElementById("attractionForm").addEventListener("submit", async e => {
      e.preventDefault();
      const name = document.getElementById("attractionName").value.trim();
      const price = document.getElementById("attractionPrice").value.trim();
      await addDoc(attractionsRef, { name, price, tsClient: Date.now(), tsServer: serverTimestamp() });
      e.target.reset();
      showToast("Attraction added");
    });

    document.getElementById("eventForm").addEventListener("submit", async e => {
      e.preventDefault();
      const day = Number(document.getElementById("eventDay").value);
      const name = document.getElementById("eventName").value.trim();
      await addDoc(eventsRef, { day, name, tsClient: Date.now(), tsServer: serverTimestamp() });
      e.target.reset();
      showToast("Event added");
    });
  </script>
</body>
</html>
